name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: .github/release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Add deployment instructions to release
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.release.outputs.version }}';
            const tagName = '${{ steps.release.outputs.tag_name }}';
            const major = '${{ steps.release.outputs.major }}';
            const minor = '${{ steps.release.outputs.minor }}';
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            
            // Get the release
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag: tagName
            });
            
            // Comprehensive deployment instructions
            const deploymentInstructions = `
            
            ---
            
            ## Docker Deployment
            
            Docker images for this release are automatically built and published to GitHub Container Registry.
            
            ### Quick Start
            
            \`\`\`bash
            # Pull the image
            docker pull ghcr.io/\${owner}/\${repo}:\${version}
            
            # Run with persistent data
            docker run -d \\
              --name video-ware \\
              -p 80:80 \\
              -v pb_data:/app/pb/pb_data \\
              -v worker_data:/app/data \\
              -e POCKETBASE_ADMIN_EMAIL=admin@example.com \\
              -e POCKETBASE_ADMIN_PASSWORD=your-secure-password \\
              ghcr.io/\${owner}/\${repo}:\${version}
            \`\`\`
            
            ### Available Image Tags
            
            | Tag | Description |
            |-----|-------------|
            | \`ghcr.io/\${owner}/\${repo}:\${version}\` | This specific version |
            | \`ghcr.io/\${owner}/\${repo}:\${major}.\${minor}\` | Latest patch for v\${major}.\${minor} |
            | \`ghcr.io/\${owner}/\${repo}:\${major}\` | Latest minor for v\${major} |
            | \`ghcr.io/\${owner}/\${repo}:latest\` | Latest stable release |
            
            ### Supported Architectures
            
            - \`linux/amd64\` - Standard x86_64 servers, Intel/AMD CPUs
            - \`linux/arm64\` - Apple Silicon Macs, AWS Graviton, ARM servers
            
            ### Environment Variables
            
            <details>
            <summary>Click to expand environment variable reference</summary>
            
            #### PocketBase Configuration
            | Variable | Default | Description |
            |----------|---------|-------------|
            | \`POCKETBASE_URL\` | \`http://localhost:8090\` | PocketBase server URL |
            | \`POCKETBASE_ADMIN_EMAIL\` | \`admin@example.com\` | Admin email |
            | \`POCKETBASE_ADMIN_PASSWORD\` | \`your-secure-password\` | Admin password |
            | \`PB_DATA_DIR\` | \`/app/pb/pb_data\` | Data storage directory |
            
            #### Worker Configuration
            | Variable | Default | Description |
            |----------|---------|-------------|
            | \`WORKER_MAX_RETRIES\` | \`3\` | Max retry attempts |
            | \`WORKER_PROVIDER\` | \`ffmpeg\` | Media provider (\`ffmpeg\` or \`google\`) |
            
            #### Monitoring
            | Variable | Default | Description |
            |----------|---------|-------------|
            | \`LOG_LEVEL\` | \`info\` | Log level (\`debug\`, \`info\`, \`warn\`, \`error\`) |
            | \`METRICS_ENABLED\` | \`false\` | Enable Prometheus metrics |
            
            </details>
            
            ### Documentation
            
            - [Docker README](docker/README.md) - Full deployment documentation
            - [Environment Variables](docker/README.md#environment-variables) - Complete configuration reference
            - [Security Scanning](docker/README.md#security-scanning) - Vulnerability scanning details
            `;
            
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body: release.body + deploymentInstructions
            });

  # Trigger Docker build after release is created
  trigger-docker-build:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit

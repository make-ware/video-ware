name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: .github/release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Add deployment instructions to release
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.release.outputs.version }}';
            const tagName = '${{ steps.release.outputs.tag_name }}';
            const major = '${{ steps.release.outputs.major }}';
            const minor = '${{ steps.release.outputs.minor }}';
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            
            // Get the release
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag: tagName
            });
            
            // Deployment instructions
            const deploymentInstructions = `
            
            ---
            
            ## Docker Deployment
            
            Images for this release are available in the GitHub Container Registry.
            
            ### Quick Start
            
            \`\`\`bash
            # Pull the image
            docker pull ghcr.io/${owner}/${repo}:${version}
            
            # Start the container
            docker run -d \\
              --name video-ware \\
              -p 8888:80 \\
              -v ./data:/data \\
              -e POCKETBASE_ADMIN_EMAIL=admin@example.com \\
              -e POCKETBASE_ADMIN_PASSWORD=your-secure-password \\
              ghcr.io/${owner}/${repo}:${version}
            \`\`\`
            
            ### Supported Architectures
            
            - \`linux/amd64\` - Standard x86_64 servers
            - \`linux/arm64\` - Apple Silicon, AWS Graviton
            
            ### Environment Variables
            
            <details>
            <summary>Environment variable reference</summary>
            
            | Variable | Default | Description |
            |----------|---------|-------------|
            | \`POCKETBASE_ADMIN_EMAIL\` | \`admin@example.com\` | Admin email |
            | \`POCKETBASE_ADMIN_PASSWORD\` | \`your-secure-password\` | Admin password |
            
            </details>
            
            ### Documentation
            
            - [Docker README](docker/README.md) - Full deployment documentation
            - [Environment Variables](docker/README.md#environment-variables) - Configuration reference
            - [Security Scanning](docker/README.md#security-scanning) - Vulnerability scanning details
            `;
            
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body: release.body + deploymentInstructions
            });

  # Trigger Docker build after release is created
  trigger-docker-build:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/docker-build.yml
    with:
      version: ${{ needs.release-please.outputs.version }}
      tag_name: ${{ needs.release-please.outputs.tag_name }}
    secrets: inherit
